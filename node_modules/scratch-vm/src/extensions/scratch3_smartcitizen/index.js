const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const Clone = require('../../util/clone');
const Color = require('../../util/color');
const formatMessage = require('format-message');
const MathUtil = require('../../util/math-util');
const RenderedTarget = require('../../sprites/rendered-target');
const log = require('../../util/log');
const StageLayering = require('../../engine/stage-layering');

/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyBpZD0ic3ZnNzgyMiIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbDpzcGFjZT0icHJlc2VydmUiIGhlaWdodD0iNDAiIHdpZHRoPSI0MCIgdmVyc2lvbj0iMS4xIiB5PSIwcHgiIHg9IjBweCIgeG1sbnM6Y2M9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL25zIyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB2aWV3Qm94PSIwIDAgNDAgNDAiPjxzdHlsZSBpZD0ic3R5bGU3ODI0IiB0eXBlPSJ0ZXh0L2NzcyI+LnN0MHtzdHJva2U6IzA3MDYwNjtzdHJva2Utd2lkdGg6MC43Njc5O3N0cm9rZS1taXRlcmxpbWl0OjEwO30uc3Qxe2Rpc3BsYXk6bm9uZTt9LnN0MntkaXNwbGF5OmlubGluZTt9LnN0M3tmaWxsOm5vbmU7c3Ryb2tlOiMwNzA2MDY7c3Ryb2tlLXdpZHRoOjAuMTkyO3N0cm9rZS1taXRlcmxpbWl0OjEwO30uc3Q0e2ZpbGw6bm9uZTtzdHJva2U6IzA3MDYwNjtzdHJva2Utd2lkdGg6MC4xOTI7c3Ryb2tlLW1pdGVybGltaXQ6MTA7c3Ryb2tlLWRhc2hhcnJheTowLjM4MjMsMC4zODIzO30uc3Q1e2ZpbGw6bm9uZTtzdHJva2U6IzA3MDYwNjtzdHJva2Utd2lkdGg6MC4xOTI7c3Ryb2tlLW1pdGVybGltaXQ6MTA7c3Ryb2tlLWRhc2hhcnJheTowLjM3MTIsMC4zNzEyO30uc3Q2e2Rpc3BsYXk6aW5saW5lO2NsaXAtcGF0aDp1cmwoI1NWR0lEXzJfKTt9LnN0N3tmaWxsOm5vbmU7c3Ryb2tlOiMwNzA2MDY7c3Ryb2tlLXdpZHRoOjAuMzg0O3N0cm9rZS1taXRlcmxpbWl0OjEwO30uc3Q4e2ZpbGw6bm9uZTt9LnN0OXtmaWxsOm5vbmU7c3Ryb2tlOiNGRkZGRkY7c3Ryb2tlLXdpZHRoOjAuNjcxOTtzdHJva2UtbWl0ZXJsaW1pdDoxMDt9LnN0MTB7ZmlsbDojRkZGRkZGO30uc3QxMXtmaWxsOiMwNzA2MDY7fS5zdDEye2Rpc3BsYXk6aW5saW5lO2ZpbGw6I0ZGMDAwMDt9LnN0MTN7ZGlzcGxheTppbmxpbmU7Y2xpcC1wYXRoOnVybCgjU1ZHSURfNF8pO30uc3QxNHtmaWxsOiNGRjAwMDA7fS5zdDE1e3N0cm9rZTojRkZGRkZGO3N0cm9rZS1taXRlcmxpbWl0OjEwO30uc3QxNntmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjAuMTkyO3N0cm9rZS1taXRlcmxpbWl0OjEwO30uc3QxN3tmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjAuMTkyO3N0cm9rZS1taXRlcmxpbWl0OjEwO3N0cm9rZS1kYXNoYXJyYXk6MC4zODIzLDAuMzgyMzt9LnN0MTh7ZmlsbDpub25lO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDowLjE5MjtzdHJva2UtbWl0ZXJsaW1pdDoxMDtzdHJva2UtZGFzaGFycmF5OjAuMzcxMiwwLjM3MTI7fS5zdDE5e2Rpc3BsYXk6aW5saW5lO2NsaXAtcGF0aDp1cmwoI1NWR0lEXzdfKTt9LnN0MjB7ZGlzcGxheTppbmxpbmU7Y2xpcC1wYXRoOnVybCgjU1ZHSURfOF8pO30uc3QyMXtmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjAuMzg0O3N0cm9rZS1taXRlcmxpbWl0OjEwO30uc3QyMntmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLW1pdGVybGltaXQ6MTA7fS5zdDIze2ZpbGw6bm9uZTtzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MC42NzE5O3N0cm9rZS1taXRlcmxpbWl0OjEwO308L3N0eWxlPjxnIGlkPSJMYXllcl8yIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLC0xMTApIiBkaXNwbGF5PSJub25lIiBjbGFzcz0ic3QxIj48ZyBpZD0iZzc5OTIiIGRpc3BsYXk9ImlubGluZSIgZmlsbD0iIzA3MDYwNiIgY2xhc3M9InN0MiI+PHBhdGggaWQ9InBhdGg3OTk0IiBjbGFzcz0ic3QxMSIgZD0ibS0xOTguNSAxOS45di4zYzMgLjggNS44IDIgOC4zIDMuNmw0LjQuMWMxLjEuOSAyLjEgMS45IDMgMi45bC0zLjctLjFjLjIuMS4zLjMuNC40LjkuOSAxLjcgMS44IDIuNCAyLjdsMy4yLjFjLjYuOSAxLjEgMS45IDEuNSAyLjlsLTMtLjFjLjYgMS4yIDEgMi40IDEuMyAzLjZsMi44LjFjLjIuOS4zIDEuOS40IDIuOGwtMi43LS4xYy4xLjUuMSAxLjEuMSAxLjYgMCAuNyAwIDEuMy0uMSAybDIuNy4xYy0uMS45LS4yIDEuOS0uNSAyLjhsLTIuOC0uMWMtLjMgMS4zLS44IDIuNS0xLjUgMy43bDMgLjFjLS40LjktMSAxLjktMS41IDIuOGwtMy44LjQtLjggNC44Yy0uMy4zLS42LjUtLjkuOC0uNi41LTEuMiAxLTEuOSAxLjR2LTMuM2MtMS4xLjktMi4zIDEuNy0zLjUgMi40djNjLS45LjUtMS44LjktMi44IDEuM3YtMi45bC0zLjYuNHYyLjVoLTIuOHYtMi41aC0zLjV2Mi41aC0yLjh2LTIuNWgtMy42djIuNWgtMi44di0yLjVoLTMuNXYyLjVoLTIuOHYtMi41aC03LjNjLjYuNy45IDEuNS45IDIuNHYuMWMwIC43LS4yIDEuNC0uNyAxLjktLjIuMi0uNC41LS43LjctLjkuOC0xLjkgMS4yLTMuMiAxLjItLjUgMC0xLjEtLjEtMS41LS4yLS42LS4yLTEuMi0uNS0xLjctLjktLjItLjItLjUtLjUtLjYtLjctLjQtLjYtLjctMS4zLS43LTIuMSAwLTEuMS40LTIgMS4zLTIuOC41LS40IDEuMS0uNyAxLjctLjkuMi0uMS40LS4xLjYtLjJ2LTIuNmgtNS43djQuMmwtMTUuOSAxMS4zdjMuN2gyMy4xdjcuNmgtMjIuN3Y0LjRoMTA2Ljh2LTY2LjloLTI5LjRsLTIyLjktLjd6bS01MCA1MS44Yy4yLjMuNC42LjQuOSAwIC40LS4xLjctLjQuOS0uMi4zLS41LjQtLjkuNC0uMyAwLS42LS4xLS45LS40LS4yLS4zLS40LS42LS40LS45IDAtLjQuMS0uNy40LS45LjItLjMuNS0uNC45LS40cy43LjIuOS40eiIvPjxwYXRoIGlkPSJwYXRoNzk5NiIgY2xhc3M9InN0MTEiIGQ9Im0tMjMyLjIgNjEuNGMtLjIuMi0uMy41LS4zLjkgMCAuMy4xLjYuMy45bC4yLjJjLjMuMy42LjQgMS4xLjQuNCAwIC44LS4xIDEuMS0uNHMuNC0uNi40LTEuMWMwLS40LS4xLS44LS40LTEuMXMtLjYtLjQtMS4xLS40Yy0uNCAwLS44LjEtMS4xLjQtLjEuMS0uMS4yLS4yLjJ6Ii8+PHBvbHlnb24gaWQ9InBvbHlnb243OTk4IiBwb2ludHM9Ii0yNDYuMiA4MS45IC0yMzkuNyA4MS45IC0yNDIuOSA3OS40IiBjbGFzcz0ic3QxMSIvPjxwb2x5Z29uIGlkPSJwb2x5Z29uODAwMCIgcG9pbnRzPSItMjQ2LjcgNzkgLTI0My4yIDc2LjQgLTI1MC4xIDc2LjQiIGNsYXNzPSJzdDExIi8+PHBvbHlnb24gaWQ9InBvbHlnb244MDAyIiBwb2ludHM9Ii0yNDEuNyA3Ni40IC0yMzguNCA3OSAtMjM1IDc2LjQiIGNsYXNzPSJzdDExIi8+PHBvbHlnb24gaWQ9InBvbHlnb244MDA0IiBwb2ludHM9Ii0yMzEuMyA4MS45IC0yMzQuNiA3OS40IC0yMzggODEuOSIgY2xhc3M9InN0MTEiLz48L2c+PC9nPjxwYXRoIGlkPSJwYXRoOTg4MCIgZD0ibTE4LjYyNiAzNi44OTRjLTUuMDE3Mi0uNDIyNzgtOS41MjAyLTMuMjE3OC0xMi4wOTYtNy41MDgtMS4xMzE2LTEuODg0Ny0xLjgxNzgtMy44NjgyLTIuMTMzOC02LjE2NzItLjExNzU3LS44NTU1Mi0uMTE3NTctMi45MjAyIDAtMy43NzU4LjUzNTUzLTMuODk3IDIuMzIzMi03LjMwNDggNS4xMi05Ljc2IDEuNjU0LTEuNDUyIDMuMzcwOC0yLjQ0MDcgNS40NDg3LTMuMTM3OS4zODY3MS0uMTI5NzYuNzEzMDQtLjI0NTg2LjcyNTE5LS4yNTgwMS4wMTIyLS4wMTIxNC0uMTc4NzQtLjY5MjQwLS40MjQxOC0xLjUxMTctLjQ4ODE4LTEuNjI5Ni0uNDk1NjktMS42ODk4LS4yNDU0NS0xLjk2OTkuMjc2OTItLjMwOTkyLjIzMTU2LS4zMjM1NSA0LjI2NzUgMS4yODIgMS45ODIzLjc4ODU1IDMuNjU5MyAxLjQ3MzQgMy43MjY4IDEuNTIxOS4zMDI2OS4yMTc3NC40MjUyLjYxNzMwLjI5NDU5Ljk2MDgzLS4wNjkyLjE4MjA5LTQuNDQyOSA2LjQ0NjMtNC42MTIyIDYuNjA1OS0uMzIyOS4zMDQzMi0uNzQ1NjguMjA0ODgtLjk0ODQ0LS4yMjMwOC0uMDY1OC0uMTM4ODEtLjMyMjUxLS45Mzk1NS0uNTcwNTQtMS43Nzk0bC0uNDUwOTYtMS41MjctLjM1MDAzLjA5ODUyYy0uNjA3MjMuMTcwOTItMS40MDE0LjQ4Njk1LTIuMDY0Ni44MjE2Mi0zLjUwODYgMS43NzA1LTUuODgwNiA1LjA5MDYtNi40ODE3IDkuMDcyNS0uMTA0MjguNjkwNzEtLjExOTYzIDIuNDA4Ni0uMDI3NCAzLjA2NDcuMjc2NTQgMS45NjcyLjg5NDQ1IDMuNjQ1NyAxLjkxMTQgNS4xOTIzLjQ3MzkwLjcyMDcgMS4wMDU2IDEuMzU3MiAxLjY4NDYgMi4wMTcgMS44MTkgMS43NjcyIDQuMDc2NiAyLjg3OCA2LjYzODEgMy4yNjYzLjgwNTEuMTIyMDIgMi4zMDg4LjE0NjMyIDMuMDY0OC4wNDk1IDIuOTgtLjM4MTU1IDUuNjkwOC0xLjc4NjggNy41ODg0LTMuOTMzNiAxLjU4MzQtMS43OTE0IDIuNTU0NC0zLjg1ODIgMi45NDItNi4yNjE4LjEyMjgxLS43NjE2NS4xMjA4MS0yLjc2OTktLjAwNC0zLjUwODQtLjM3NDg5LTIuMjI3Mi0xLjE2MTUtNC4wMTktMi41MzIxLTUuNzY3OC0uMzc5MjQtLjQ4MzkxLS40Mjk1LS41ODg2NS0uMzY0MTUtLjc1ODkzLjAxNjUtLjA0My41ODAwNi0uNTA5NjUgMS4yNTI0LTEuMDM3MSAxLjM0OTctMS4wNTg4IDEuMzk2LTEuMDgxOCAxLjY2NTYtLjgyNDk4LjI1MDQ0LjIzODUyIDEuMDI1IDEuMjgzMSAxLjQyNTIgMS45MjIgNC4zMzMzIDYuOTE4MiAyLjYxODIgMTUuOTg0LTMuOTQxIDIwLjgzMS0yLjk5NyAyLjIxNDYtNi44NDE2IDMuMzEzOS0xMC41MDkgMy4wMDQ4em0tNS41ODEtOS4zNjA5Yy0uMjE2MDQtLjA2NDgtLjQ2NTUxLS4yNzk3OS0uNTg1Ny0uNTA0NjMtLjEwNjU2LS4xOTkzNi0uMTA5ODctLjI0ODQ4LS4xMDk4Ny0xLjYyNzZ2LTEuNDIybC4xMjI1OS0uMjE4NDljLjMyNDc5LS41Nzg4NSAxLjA2NDMtLjcxMTU3IDEuNTU2NS0uMjc5MzYuMjUzMjIuMjIyMzMuMzUzNTEuNDc4MDMuMzU0NzkuOTA0NjNsLjAwMTAuMzU3NzUtLjMzMDk5LS4wMTQ1LS4zMzEtLjAxNDUtLjAxNDktLjMxODM5Yy0uMDExNC0uMjQzMi0uMDM5NS0uMzQ0NTMtLjExODg4LS40MjkwNi0uMTkzMy0uMjA1NzYtLjUyOTY2LS4wOTY2LS42MDMwMS4xOTU2Mi0uMDE1Ni4wNjItLjAyMTYuNjU3NzMtLjAxMzUgMS4zMjM5LjAxNDMgMS4xNzE4LjAxODMgMS4yMTQ4LjEyMjM3IDEuMzE4OC4xMzIxNS4xMzIwNC4zNjk0Ni4xNDA1OS41MDQ3MS4wMTgyLjA4MjktLjA3NTEuMDk4Ny0uMTUwNzguMDk4Ny0uNDc0MDF2LS4zODQ2OWguMzQzMjYuMzQzMjVsLS4wMDEwLjQwNDU1Yy0uMDAwNzcuMjg4NjMtLjAyNzEuNDYwNzQtLjA5MTkuNjAwNjgtLjIyMTM4LjQ3ODE1LS43NDM1NS43MTQwNC0xLjI0NjUuNTYzMDh6bTEuODc4OC0yLjEzMjJ2LTIuMTMzaC4zMTg3NC4zMTg3M3YyLjEzMyAyLjEzMzFoLS4zMTg3My0uMzE4NzR6bTEuODE0My4zMTg3M3YtMS44MTQzaC0uMzQzMjUtLjM0MzI1di0uMzE4NzMtLjMxODczaDEuMDA1MiAxLjAwNTJ2LjMxODczLjMxODczaC0uMzQzMjUtLjM0MzI2djEuODE0MyAxLjgxNDNoLS4zMTg3My0uMzE4NzR6bTEuODYzNC0uMzE4NzN2LTIuMTMzaC4zMTg3My4zMTg3NHYyLjEzMyAyLjEzMzFoLS4zMTg3NC0uMzE4NzN6bTEuMTc2OSAxLjc3NjdjMC0uMzQwMTIuMDI1Ny0uNDIwNTEuNTYzOTItMS43NjUxLjMxMDE1LS43NzQ3OS41NjM5Mi0xLjQzMDkuNTYzOTItMS40NTggMC0uMDMwMS0uMjE4OTQtLjA0OTMtLjU2MzkyLS4wNDkzaC0uNTYzOTJ2LS4zMTg3My0uMzE4NzNoLjkzMTY5LjkzMTY5di4zMTgzOGMwIC4yOTIzNy0uMDQ4MS40Mzg2NS0uNTg4NDQgMS43OTAyLS4zMjM2My44MDk0Ny0uNTg4NDMgMS40ODI2LS41ODg0MyAxLjQ5NTlzLjI2NDguMDI0Mi41ODg0My4wMjQyaC41ODg0NHYuMzE4NzMuMzE4NzNoLS45MzE2OS0uOTMxNjl6bTIuNDAyOC0xLjc3Njd2LTIuMTMzaC45MDcxNy45MDcxNnYuMzE4NzMuMzE4NzNoLS41ODg0My0uNTg4NDN2LjU4ODQzLjU4ODQzaC40MTY4LjQxNjgxdi4zMTg3My4zMTg3M2gtLjQxNjgxLS40MTY4di41ODg0My41ODg0M2guNTg4NDMuNTg4NDN2LjMxODczLjMxODc0aC0uOTA3MTYtLjkwNzE3em0yLjI1NTcgMHYtMi4xMzNoLjM2MDIxLjM2MDIxbC40MTIxMSAxLjM4NTMuNDEyMTEgMS4zODUzLjAxMy0xLjM4NTMuMDEzLTEuMzg1M2guMzE3OTcuMzE3OTd2Mi4xMzMgMi4xMzMxaC0uMzQwNzgtLjM0MDc5bC0uNDM4ODItMS4zMzYyLS40Mzg4My0xLjMzNjItLjAwNSAxLjMzNjItLjAwNSAxLjMzNjJoLS4zMTg3NC0uMzE4NzN2LTIuMTMzMXptLTEzLjg2OS0yLjY3NDJjLS40Njg5OC0uMjM2ODctMC43MzctLjY3MzgzLS44NjA3Mi0xLjQwMzItLjAzMTEtLjE4MzY5LjAxMTItLjIwMTEuNTMyNjEtLjIxODc2bC4zNDI1Mi0uMDExNi4wMzUyLjIwNjIyYy4wNzIzLjQyMzYuMzQ2NzYuNzQyOTQuNjM4MDcuNzQyNDYuMjc5NzYtLjAwMDQ0LjU3ODk3LS4zNDY2Ny41NzgzNC0uNjY5Mi0uMDAwNzQtLjM3NzQxLS4wODUxLS41MDIyNi0uOTA1ODMtMS4zNC0uODY3NTYtLjg4NTU2LTEuMDEzNC0xLjEwMDQtMS4xMDU0LTEuNjI4OS0uMDYzNy0uMzY1OTMtLjAwMy0uODIyNjMuMTQ5OTYtMS4xMjE4LjEzMTMzLS4yNTc0Mi40OTUzOC0uNTU5ODIuNzY5OTgtLjYzOTU5LjUzODYzLS4xNTY0NyAxLjE2ODktLjAyNjQgMS41MjUuMzE0NzMuMjE2ODcuMjA3NzYuNDA1MDcuNTg1MjEuNDE1OTIuODM0MjJsLjAwOS4yMDA5Ny0uNDIyMjIuMDc4NS0uNDIyMjIuMDc4NS0uMDU5Ny0uMjMyODFjLS4xOTQ1OS0uNzU5MjYtMS4wMzQxLS42MjgyNi0xLjAzMjMuMTYxMDguMDAwOTIuNDA1LjE4NzM0LjY4NzgyLjkzMTE0IDEuNDEyNi42MS41OTQzOC43MDEwNS43MDUxOS44Njc5MiAxLjA1NjMuMTczMzMuMzY0NzEuMTg2MzguNDIzMy4xODU3LjgzMzYtLjAwMDgyLjQ5ODc1LS4wODgzLjc1MzgxLS4zNjc1OCAxLjA3MTktLjI2MTUzLjI5Nzg2LS40OTI2MS4zOTA0NS0xLjAyOTIuNDEyMzktLjQ0NDczLjAxODItLjQ3OTkuMDExOS0uNzc1OTMtLjEzNzU3em0yLjk4MjYtMi45ODk0di0zLjA4OTJoLjY1Njc0Yy40ODA2NiAwIC42NjI4LjAxNjQuNjc5MzIuMDYxMy4wMTI0LjAzMzcuMjA3MjIgMS4wMTQ0LjQzMjg5IDIuMTc5NC4yMjU2NiAxLjE2NS40MTgwNCAyLjExMDQuNDI3NSAyLjEwMDkuMDEtLjAwOS4xOTk1OS0uOTg0NjguNDIyNTItMi4xNjcybC40MDUzMy0yLjE1LjY0NTQ0LS4wMTM3LjY0NTQ0LS4wMTM3djMuMDkwNyAzLjA5MDdoLS40NjU4NC0uNDY1ODRsLS4wMDUtMS45MDAxLS4wMDUtMS45MDAxLS4wOTcyLjQ0MTMyYy0uMDUzNC4yNDI3My0uMjMzMjUgMS4wOTIzLS4zOTk1NCAxLjg4NzlsLS4zMDIzNiAxLjQ0NjYtLjM3NDQ5LjAxNDItLjM3NDUuMDE0Mi0uMTIyOTYtLjUyOTFjLS4wNjc2LS4yOTEwMS0uMjYzMjEtMS4xMzQxLS40MzQ2MS0xLjg3MzRsLS4zMTE2NC0xLjM0NDMtLjAxMjggMS44NzE1LS4wMTI4IDEuODcxNWgtLjQ2NTI2LS40NjUyNnYtMy4wODkyem01LjA5OTkgMy4wNTI1Yy4wMDAwNS0uMDIwMi4yMzE3Ni0xLjQwMDcuNTE0ODgtMy4wNjc3LjI4MzEzLTEuNjY3LjUxNDc4LTMuMDQxMy41MTQ3OC0zLjA1MzlzLjI5MTU2LS4wMTY4LjY0NzktLjAwOWwuNjQ3OS4wMTM3LjUwMTQxIDIuOTkxMmMuMjc1NzggMS42NDUyLjUwMjc4IDMuMDI5OC41MDQ0NSAzLjA3Ny4wMDMuMDc2MS0uMDUxNC4wODU4LS40Nzg4NC4wODU4aC0uNDgxODdsLS4wNjAxLS40MDQ1NWMtLjAzMy0uMjIyNS0uMDgzMy0uNTQyNDYtLjExMTU5LS43MTEwMmwtLjA1MTUtLjMwNjQ3aC0uNDgwMy0uNDgwMjlsLS4wNTE1LjMwNjQ3Yy0uMDI4My4xNjg1Ni0uMDc4Ni40ODg1Mi0uMTExNTkuNzExMDJsLS4wNjAxLjQwNDU1aC0uNDgxODhjLS4yNjUwMyAwLS40ODE4My0uMDE2Ni0uNDgxNzgtLjAzNjh6bTEuOTk2OS0yLjQ1MThjLS4wMTQyLS4wNzQyLS4wODc4LS41ODE0My0uMTYzNjItMS4xMjcyLS4wNzU4LS41NDU4Mi0uMTUyLS45NzYxMS0uMTY5MjctLjk1NjItLjAxNzMuMDE5OS0uMDkwOS40Nzc1My0uMTYzNTIgMS4wMTY5LS4wNzI3LjUzOTM5LS4xNDI1NSAxLjAzMDQtLjE1NTMgMS4wOTEtLjAyMjMuMTA2MjktLjAxMDMuMTEwMzMuMzI3MTQuMTEwMzNoLjM1MDMxbC0uMDI1OC0uMTM0ODR6bTIuMTIyLS42MDA2OXYtMy4wODkyaC44OTgyN2MxLjA0NzEgMCAxLjMwMTIuMDUyNiAxLjYxMzQuMzMzNzYuMzQyLjMwODA0LjM5OTk1LjUwMjQxLjQyMTYxIDEuNDE0Mi4wMjIuOTI3NTctLjAzMzggMS4yMDE2LS4zMTA2NCAxLjUyNTFsLS4xNzYwOS4yMDU3My4zMjM3MyAxLjI2NGMuMTc4MDUuNjk1MjIuMzM1MTkgMS4zMDI2LjM0OTIxIDEuMzQ5OC4wMjMxLjA3NzgtLjAyMTcuMDg1OC0uNDgyNzkuMDg1OGgtLjUwODI3bC0uMjgzOTgtMS4xNzkxLS4yODM5Ny0xLjE3OTEtLjMwMjExLjAxNDUtLjMwMjExLjAxNDUtLjAxMzEgMS4xNjQ2LS4wMTMyIDEuMTY0NmgtLjQ2NDk2LS40NjQ5NnYtMy4wODkyem0xLjgxNjgtLjI3MDQzYy4xODIwMy0uMTYyMjkuMjQyNzctLjM3OTc0LjI0MjQ4LS44NjgwOC0uMDAwNTEtLjg1MzQ5LS4wOTcyLS45OTAzMy0uNzAxNzktLjk5Mjg2bC0uNDAxMjUtLjAwMi0uMDEzNC45MzAxNmMtLjAwNy41MTE2LS4wMDIuOTYwODQuMDEyOC45OTgzMS4wNDI2LjExMDk1LjcyMTA3LjA1OTEuODYxMTctLjA2NTh6bTIuNzkyNi43MzYyN3YtMi42MjM0aC0uNDkwMzYtLjQ5MDM2di0uNDY1ODQtLjQ2NTg0aDEuNDQ2NiAxLjQ0NjZ2LjQ2NTg0LjQ2NTg0aC0uNDkwMzYtLjQ5MDM2djIuNjIzNCAyLjYyMzRoLS40NjU4NS0uNDY1ODR6bS0zLjc3Ny0xMS4zMDJjLTE1LjczNSAyMC43MzMtNy44Njc3IDEwLjM2NyAwIDB6Ii8+PC9zdmc+';

/**
 * Enum for Smartcitizen color parameter values.
 * @readonly
 * @enum {string}
 */
const ColorParam = {
    COLOR: 'color',
    SATURATION: 'saturation',
    BRIGHTNESS: 'brightness',
    TRANSPARENCY: 'transparency'
};
/**
 * Enum for Smartcitizen Days parameter values.
 * @readonly
 * @enum {string}
 */
const WeekParam = {
    DAY1: 'monday',
    DAY2: 'tuesday',
    DAY3: 'wednesday',
    DAY4: 'thursday',
    DAY5: 'friday',
    DAY6: 'saturday',
    DAY7: 'sunday',

};

/**
 * @typedef {object} SmartcitizenState - the Smartcitizen state associated with a particular target.
 * @property {Boolean} SmartcitizenDown - tracks whether the Smartcitizen should draw for this target.
 * @property {number} color - the current color (hue) of the Smartcitizen.
 * @property {SmartcitizenAttributes} SmartcitizenAttributes - cached Smartcitizen attributes for the renderer. This is the authoritative value for
 *   diameter but not for Smartcitizen color.
 */

/**
 * Host for the Smartcitizen-related blocks in Scratch 3.0
 * @param {Runtime} runtime - the runtime instantiating this block package.
 * @constructor
 */
class Scratch3SmartcitizenBlocks {
    constructor (runtime) {
        /**
         * The runtime instantiating this block package.
         * @type {Runtime}
         */
        this.runtime = runtime;

        /**
         * The ID of the renderer Drawable corresponding to the Smartcitizen layer.
         * @type {int}
         * @private
         */
        this._SmartcitizenDrawableId = -1;

        /**
         * The ID of the renderer Skin corresponding to the Smartcitizen layer.
         * @type {int}
         * @private
         */
        this._SmartcitizenSkinId = -1;

        this._onTargetCreated = this._onTargetCreated.bind(this);
        this._onTargetMoved = this._onTargetMoved.bind(this);

        runtime.on('targetWasCreated', this._onTargetCreated);
    }

    /**
     * The default Smartcitizen state, to be used when a target has no existing Smartcitizen state.
     * @type {SmartcitizenState}
     */
    static get DEFAULT_Smartcitizen_STATE () {
        return {
            SmartcitizenDown: false,
            color: 66.66,
            saturation: 100,
            brightness: 100,
            transparency: 0,
            _shade: 50, // Used only for legacy `change shade by` blocks
            SmartcitizenAttributes: {
                color4f: [0, 0, 1, 1],
                diameter: 1,
                day: "friday",
                id:"",
                time:"",
                variable:""
            }
        };
    }


    /**
     * The minimum and maximum allowed Smartcitizen size.
     * The maximum is twice the diagonal of the stage, so that even an
     * off-stage sprite can fill it.
     * @type {{min: number, max: number}}
     */
    static get Smartcitizen_SIZE_RANGE () {
        return {min: 1, max: 1200};
    }

    /**
     * The key to load & store a target's Smartcitizen-related state.
     * @type {string}
     */
    static get STATE_KEY () {
        return 'Scratch.Smartcitizen';
    }

    /**
     * Clamp a Smartcitizen size value to the range allowed by the Smartcitizen.
     * @param {number} requestedSize - the requested Smartcitizen size.
     * @returns {number} the clamped size.
     * @private
     */
    _clampSmartcitizenSize (requestedSize) {
        return MathUtil.clamp(
            requestedSize,
            Scratch3SmartcitizenBlocks.Smartcitizen_SIZE_RANGE.min,
            Scratch3SmartcitizenBlocks.Smartcitizen_SIZE_RANGE.max
        );
    }

    /**
     * Retrieve the ID of the renderer "Skin" corresponding to the Smartcitizen layer. If
     * the Smartcitizen Skin doesn't yet exist, create it.
     * @returns {int} the Skin ID of the Smartcitizen layer, or -1 on failure.
     * @private
     */
    _getSmartcitizenLayerID () {
        if (this._SmartcitizenSkinId < 0 && this.runtime.renderer) {
            this._SmartcitizenSkinId = this.runtime.renderer.createSmartcitizenSkin();
            this._SmartcitizenDrawableId = this.runtime.renderer.createDrawable(StageLayering.Smartcitizen_LAYER);
            this.runtime.renderer.updateDrawableProperties(this._SmartcitizenDrawableId, {skinId: this._SmartcitizenSkinId});
        }
        return this._SmartcitizenSkinId;
    }

    /**
     * @param {Target} target - collect Smartcitizen state for this target. Probably, but not necessarily, a RenderedTarget.
     * @returns {SmartcitizenState} the mutable Smartcitizen state associated with that target. This will be created if necessary.
     * @private
     */
    _getSmartcitizenState (target) {
        let SmartcitizenState = target.getCustomState(Scratch3SmartcitizenBlocks.STATE_KEY);
        if (!SmartcitizenState) {
            SmartcitizenState = Clone.simple(Scratch3SmartcitizenBlocks.DEFAULT_Smartcitizen_STATE);
            target.setCustomState(Scratch3SmartcitizenBlocks.STATE_KEY, SmartcitizenState);
        }
        return SmartcitizenState;
    }

    /**
     * When a Smartcitizen-using Target is cloned, clone the Smartcitizen state.
     * @param {Target} newTarget - the newly created target.
     * @param {Target} [sourceTarget] - the target used as a source for the new clone, if any.
     * @listens Runtime#event:targetWasCreated
     * @private
     */
    _onTargetCreated (newTarget, sourceTarget) {
        if (sourceTarget) {
            const SmartcitizenState = sourceTarget.getCustomState(Scratch3SmartcitizenBlocks.STATE_KEY);
            if (SmartcitizenState) {
                newTarget.setCustomState(Scratch3SmartcitizenBlocks.STATE_KEY, Clone.simple(SmartcitizenState));
                if (SmartcitizenState.SmartcitizenDown) {
                    newTarget.addListener(RenderedTarget.EVENT_TARGET_MOVED, this._onTargetMoved);
                }
            }
        }
    }

    /**
     * Handle a target which has moved. This only fires when the Smartcitizen is down.
     * @param {RenderedTarget} target - the target which has moved.
     * @param {number} oldX - the previous X position.
     * @param {number} oldY - the previous Y position.
     * @param {boolean} isForce - whether the movement was forced.
     * @private
     */
    _onTargetMoved (target, oldX, oldY, isForce) {
        // Only move the Smartcitizen if the movement isn't forced (ie. dragged).
        if (!isForce) {
            const SmartcitizenSkinId = this._getSmartcitizenLayerID();
            if (SmartcitizenSkinId >= 0) {
                const SmartcitizenState = this._getSmartcitizenState(target);
                this.runtime.renderer.SmartcitizenLine(SmartcitizenSkinId, SmartcitizenState.SmartcitizenAttributes, oldX, oldY, target.x, target.y);
                this.runtime.requestRedraw();
            }
        }
    }

    /**
     * Wrap a color input into the range (0,100).
     * @param {number} value - the value to be wrapped.
     * @returns {number} the wrapped value.
     * @private
     */
    _wrapColor (value) {
        return MathUtil.wrapClamp(value, 0, 100);
    }

    /**
     * Initialize color parameters menu with localized strings
     * @returns {array} of the localized text and values for each menu element
     * @private
     */
    _initColorParam () {
        return [
            {
                text: formatMessage({
                    id: 'Smartcitizen.colorMenu.color',
                    default: 'color',
                    description: 'label for color element in color picker for Smartcitizen extension'
                }),
                value: ColorParam.COLOR
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.colorMenu.saturation',
                    default: 'saturation',
                    description: 'label for saturation element in color picker for Smartcitizen extension'
                }),
                value: ColorParam.SATURATION
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.colorMenu.brightness',
                    default: 'brightness',
                    description: 'label for brightness element in color picker for Smartcitizen extension'
                }),
                value: ColorParam.BRIGHTNESS
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.colorMenu.transparency',
                    default: 'transparency',
                    description: 'label for transparency element in color picker for Smartcitizen extension'
                }),
                value: ColorParam.TRANSPARENCY

            }
        ];
    }

    /**
     * Initialize DAYS parameters menu with localized strings
     * @returns {array} of the localized text and values for each menu element
     * @private
     */
    _initWeekParam () {
        return [
            {
                text: formatMessage({
                    id: 'Smartcitizen.weekMenu.monday',
                    default: 'monday',
                    description: 'label for day 1 element in week picker for Smartcitizen extension'
                }),
                value: WeekParam.DAY1
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.weekMenu.tuesday',
                    default: 'tuesday',
                    description: 'label for day 2 element in week picker for Smartcitizen extension'
                }),
                value: WeekParam.DAY2
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.weekMenu.wednesday',
                    default: 'wednesday',
                    description: 'label for day 3 element in week picker for Smartcitizen extension'
                }),
                value: WeekParam.DAY3
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.weekMenu.thursday',
                    default: 'thursday',
                    description: 'label for day 4 element in week picker for Smartcitizen extension'
                }),
                value: WeekParam.DAY4
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.weekMenu.friday',
                    default: 'friday',
                    description: 'label for day 5 element in week picker for Smartcitizen extension'
                }),
                value: WeekParam.DAY5
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.weekMenu.saturday',
                    default: 'saturday',
                    description: 'label for day 6 element in week picker for Smartcitizen extension'
                }),
                value: WeekParam.DAY6
            },
            {
                text: formatMessage({
                    id: 'Smartcitizen.weekMenu.sunday',
                    default: 'sunday',
                    description: 'label for day 7 element in week picker for Smartcitizen extension'
                }),
                value: WeekParam.DAY7
            }


        ];
    }
    /**
     * Clamp a Smartcitizen color parameter to the range (0,100).
     * @param {number} value - the value to be clamped.
     * @returns {number} the clamped value.
     * @private
     */
    _clampColorParam (value) {
        return MathUtil.clamp(value, 0, 100);
    }

    /**
     * Convert an alpha value to a Smartcitizen transparency value.
     * Alpha ranges from 0 to 1, where 0 is transparent and 1 is opaque.
     * Transparency ranges from 0 to 100, where 0 is opaque and 100 is transparent.
     * @param {number} alpha - the input alpha value.
     * @returns {number} the transparency value.
     * @private
     */
    _alphaToTransparency (alpha) {
        return (1.0 - alpha) * 100.0;
    }

    /**
     * Convert a Smartcitizen transparency value to an alpha value.
     * Alpha ranges from 0 to 1, where 0 is transparent and 1 is opaque.
     * Transparency ranges from 0 to 100, where 0 is opaque and 100 is transparent.
     * @param {number} transparency - the input transparency value.
     * @returns {number} the alpha value.
     * @private
     */
    _transparencyToAlpha (transparency) {
        return 1.0 - (transparency / 100.0);
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo () {
        return {
            id: 'Smartcitizen',
            name: formatMessage({
                id: 'Smartcitizen.categoryName',
                default: 'Smartcitizen',
                description: 'Label for the Smartcitizen extension category'
            }),
            blockIconURI: blockIconURI,
            blocks: [
              /*  {
                    opcode: 'clear',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.clear',
                        default: 'borrar all',
                        description: 'erase all Smartcitizen trails and stamps'
                    })
                },
                {
                    opcode: 'stamp',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.stamp',
                        default: 'stamp',
                        description: 'render current costume on the background'
                    })
                },
                {
                    opcode: 'SmartcitizenDown',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.SmartcitizenDown',
                        default: 'Smartcitizen down',
                        description: 'start leaving a trail when the sprite moves'
                    })
                },
                {
                    opcode: 'SmartcitizenUp',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.SmartcitizenUp',
                        default: 'Smartcitizen up',
                        description: 'stop leaving a trail behind the sprite'
                    })
                },
                {
                    opcode: 'setSmartcitizenColorToColor',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.setColor',
                        default: 'set Smartcitizen color to [COLOR]',
                        description: 'set the Smartcitizen color to a particular (RGB) value'
                    }),
                    arguments: {
                        COLOR: {
                            type: ArgumentType.COLOR
                        }
                    }
                },
                {
                    opcode: 'changeSmartcitizenColorParamBy',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.changeColorParam',
                        default: 'change Smartcitizen [COLOR_PARAM] by [VALUE]',
                        description: 'change the state of a Smartcitizen color parameter'
                    }),
                    arguments: {
                        COLOR_PARAM: {
                            type: ArgumentType.STRING,
                            menu: 'colorParam',
                            defaultValue: ColorParam.COLOR
                        },
                        VALUE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 10
                        }
                    }
                },
                {
                    opcode: 'setSmartcitizenColorParamTo',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.setColorParam',
                        default: 'set Smartcitizen [COLOR_PARAM] to [VALUE]',
                        description: 'set the state for a Smartcitizen color parameter e.g. saturation'
                    }),
                    arguments: {
                        COLOR_PARAM: {
                            type: ArgumentType.STRING,
                            menu: 'colorParam',
                            defaultValue: ColorParam.COLOR
                        },
                        VALUE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 50
                        }
                    }
                },*/
                {
                    opcode: 'getSmartcitizenKitData',
                    blockType: BlockType.REPORTER,
                    text: formatMessage({
                        id: 'Smartcitizen.getData',
                        default: 'Get Noise Level from kit ID [ID] day [DAY] at time [HOUR] h',
                        description: 'Select the kit ID of the Smartcitizen Kit'
                    }),
                    arguments: {
                        ID: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 0
                        },
                        DAY: {
                            type: ArgumentType.STRING,
                            menu: 'weekParam',
                            defaultValue: WeekParam.DAY5
                        },
                        HOUR: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 0
                        }
                    }
                },/*,
                {
                    opcode: 'setSmartcitizenSizeTo',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.setSize',
                        default: 'set Smartcitizen size to [SIZE]',
                        description: 'set the diameter of a trail left by a sprite'
                    }),
                    arguments: {
                        SIZE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 1
                        }
                    }
                },*/
                /* Legacy blocks, should not be shown in flyout */
                {
                    opcode: 'setSmartcitizenShadeToNumber',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.setShade',
                        default: 'set Smartcitizen shade to [SHADE]',
                        description: 'legacy Smartcitizen blocks - set Smartcitizen shade'
                    }),
                    arguments: {
                        SHADE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 1
                        }
                    },
                    hideFromPalette: true
                },
                {
                    opcode: 'changeSmartcitizenShadeBy',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.changeShade',
                        default: 'change Smartcitizen shade by [SHADE]',
                        description: 'legacy Smartcitizen blocks - change Smartcitizen shade'
                    }),
                    arguments: {
                        SHADE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 1
                        }
                    },
                    hideFromPalette: true
                },
                {
                    opcode: 'setSmartcitizenHueToNumber',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.setHue',
                        default: 'set Smartcitizen color to [HUE]',
                        description: 'legacy Smartcitizen blocks - set Smartcitizen color to number'
                    }),
                    arguments: {
                        HUE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 1
                        }
                    },
                    hideFromPalette: true
                },
                {
                    opcode: 'changeSmartcitizenHueBy',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'Smartcitizen.changeHue',
                        default: 'change Smartcitizen color by [HUE]',
                        description: 'legacy Smartcitizen blocks - change Smartcitizen color'
                    }),
                    arguments: {
                        HUE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 1
                        }
                    },
                    hideFromPalette: true
                }
            ],
            menus: {
                colorParam: this._initColorParam(),
                weekParam: this._initWeekParam()
            }
        };
    }

    /**
     * The Smartcitizen "clear" block clears the Smartcitizen layer's contents.
     */
    clear () {
        const SmartcitizenSkinId = this._getSmartcitizenLayerID();
        if (SmartcitizenSkinId >= 0) {
            this.runtime.renderer.SmartcitizenClear(SmartcitizenSkinId);
            this.runtime.requestRedraw();
        }
    }

    /**
     * The Smartcitizen "stamp" block stamps the current drawable's image onto the Smartcitizen layer.
     * @param {object} args - the block arguments.
     * @param {object} util - utility object provided by the runtime.
     */
    stamp (args, util) {
        const SmartcitizenSkinId = this._getSmartcitizenLayerID();
        if (SmartcitizenSkinId >= 0) {
            const target = util.target;
            this.runtime.renderer.SmartcitizenStamp(SmartcitizenSkinId, target.drawableID);
            this.runtime.requestRedraw();
        }
    }

    /**
     * The Smartcitizen "Smartcitizen down" block causes the target to leave Smartcitizen trails on future motion.
     * @param {object} args - the block arguments.
     * @param {object} util - utility object provided by the runtime.
     */
    SmartcitizenDown (args, util) {
        const target = util.target;
        const SmartcitizenState = this._getSmartcitizenState(target);

        if (!SmartcitizenState.SmartcitizenDown) {
            SmartcitizenState.SmartcitizenDown = true;
            target.addListener(RenderedTarget.EVENT_TARGET_MOVED, this._onTargetMoved);
        }

        const SmartcitizenSkinId = this._getSmartcitizenLayerID();
        if (SmartcitizenSkinId >= 0) {
            this.runtime.renderer.SmartcitizenPoint(SmartcitizenSkinId, SmartcitizenState.SmartcitizenAttributes, target.x, target.y);
            this.runtime.requestRedraw();
        }
    }

    /**
     * The Smartcitizen "Smartcitizen up" block stops the target from leaving Smartcitizen trails.
     * @param {object} args - the block arguments.
     * @param {object} util - utility object provided by the runtime.
     */
    SmartcitizenUp (args, util) {
        const target = util.target;
        const SmartcitizenState = this._getSmartcitizenState(target);

        if (SmartcitizenState.SmartcitizenDown) {
            SmartcitizenState.SmartcitizenDown = false;
            target.removeListener(RenderedTarget.EVENT_TARGET_MOVED, this._onTargetMoved);
        }
    }

    /**
     * The Smartcitizen "set Smartcitizen color to {color}" block sets the Smartcitizen to a particular RGB color.
     * The transparency is reset to 0.
     * @param {object} args - the block arguments.
     *  @property {int} COLOR - the color to set, expressed as a 24-bit RGB value (0xRRGGBB).
     * @param {object} util - utility object provided by the runtime.
     */
    setSmartcitizenColorToColor (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        const rgb = Cast.toRgbColorObject(args.COLOR);
        const hsv = Color.rgbToHsv(rgb);
        SmartcitizenState.color = (hsv.h / 360) * 100;
        SmartcitizenState.saturation = hsv.s * 100;
        SmartcitizenState.brightness = hsv.v * 100;
        if (rgb.hasOwnProperty('a')) {
            SmartcitizenState.transparency = 100 * (1 - (rgb.a / 255.0));
        } else {
            SmartcitizenState.transparency = 0;
        }

        // Set the legacy "shade" value the same way scratch 2 did.
        SmartcitizenState._shade = SmartcitizenState.brightness / 2;

        this._updateSmartcitizenColor(SmartcitizenState);
    }
    /**
     * Update the cached color from the color, saturation, brightness and transparency values
     * in the provided SmartcitizenState object.
     * @param {SmartcitizenState} SmartcitizenState - the Smartcitizen state to update.
     * @private
     */
    _updateSmartcitizenColor (SmartcitizenState) {
        const rgb = Color.hsvToRgb({
            h: SmartcitizenState.color * 360 / 100,
            s: SmartcitizenState.saturation / 100,
            v: SmartcitizenState.brightness / 100
        });
        SmartcitizenState.SmartcitizenAttributes.color4f[0] = rgb.r / 255.0;
        SmartcitizenState.SmartcitizenAttributes.color4f[1] = rgb.g / 255.0;
        SmartcitizenState.SmartcitizenAttributes.color4f[2] = rgb.b / 255.0;
        SmartcitizenState.SmartcitizenAttributes.color4f[3] = this._transparencyToAlpha(SmartcitizenState.transparency);
    }

    /**
     * Update the cached color from the color, saturation, brightness and transparency values
     * in the provided SmartcitizenState object.
     * @param {SmartcitizenState} SmartcitizenState - the Smartcitizen state to update.
     * @private
     */
    _updateSmartcitizenKit (SmartcitizenState) {

        alert(SmartcitizenState.SmartcitizenAttributes.day);
    }

    /**
     * Set or change a single color parameter on the Smartcitizen state, and update the Smartcitizen color.
     * @param {ColorParam} param - the name of the color parameter to set or change.
     * @param {number} value - the value to set or change the param by.
     * @param {SmartcitizenState} SmartcitizenState - the Smartcitizen state to update.
     * @param {boolean} change - if true change param by value, if false set param to value.
     * @private
     */
    _setOrChangeColorParam (param, value, SmartcitizenState, change) {
        switch (param) {
        case ColorParam.COLOR:
            SmartcitizenState.color = this._wrapColor(value + (change ? SmartcitizenState.color : 0));
            break;
        case ColorParam.SATURATION:
            SmartcitizenState.saturation = this._clampColorParam(value + (change ? SmartcitizenState.saturation : 0));
            break;
        case ColorParam.BRIGHTNESS:
            SmartcitizenState.brightness = this._clampColorParam(value + (change ? SmartcitizenState.brightness : 0));
            break;
        case ColorParam.TRANSPARENCY:
            SmartcitizenState.transparency = this._clampColorParam(value + (change ? SmartcitizenState.transparency : 0));
            break;
        default:
            log.warn(`Tried to set or change unknown color parameter: ${param}`);
        }
        this._updateSmartcitizenColor(SmartcitizenState);
    }

    /**
     * The "change Smartcitizen {ColorParam} by {number}" block changes one of the Smartcitizen's color parameters
     * by a given amound.
     * @param {object} args - the block arguments.
     *  @property {ColorParam} COLOR_PARAM - the name of the selected color parameter.
     *  @property {number} VALUE - the amount to change the selected parameter by.
     * @param {object} util - utility object provided by the runtime.
     */
    changeSmartcitizenColorParamBy (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        this._setOrChangeColorParam(args.COLOR_PARAM, Cast.toNumber(args.VALUE), SmartcitizenState, true);
    }

    /**
     * The "set Smartcitizen {ColorParam} to {number}" block sets one of the Smartcitizen's color parameters
     * to a given amound.
     * @param {object} args - the block arguments.
     *  @property {ColorParam} COLOR_PARAM - the name of the selected color parameter.
     *  @property {number} VALUE - the amount to set the selected parameter to.
     * @param {object} util - utility object provided by the runtime.
     */
    setSmartcitizenColorParamTo (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        this._setOrChangeColorParam(args.COLOR_PARAM, Cast.toNumber(args.VALUE), SmartcitizenState, false);
    }

    /** DAY WEEK
     * Set or change a single color parameter on the Smartcitizen state, and update the Smartcitizen color.
     * @param {WeekParam} param - the name of the color parameter to set or change.
     * @param {number} value - the value to set or change the param by.
     * @param {SmartcitizenState} SmartcitizenState - the Smartcitizen state to update.
     * @param {boolean} change - if true change param by value, if false set param to value.
     * @private
     */
    _setOrChangeKitParam (param, value, SmartcitizenState, change) {
      alert(param);
      /*  switch (param) {
        case ColorParam.COLOR:
            SmartcitizenState.color = this._wrapColor(value + (change ? SmartcitizenState.color : 0));
            break;
        case ColorParam.SATURATION:
            SmartcitizenState.saturation = this._clampColorParam(value + (change ? SmartcitizenState.saturation : 0));
            break;
        case ColorParam.BRIGHTNESS:
            SmartcitizenState.brightness = this._clampColorParam(value + (change ? SmartcitizenState.brightness : 0));
            break;
        case ColorParam.TRANSPARENCY:
            SmartcitizenState.transparency = this._clampColorParam(value + (change ? SmartcitizenState.transparency : 0));
            break;
        default:
            log.warn(`Tried to set or change unknown day parameter: ${param}`);
        }*/
        this._updateSmartcitizenKit(SmartcitizenState);
    }

    /**
     * The "change Smartcitizen {ColorParam} by {number}" block changes one of the Smartcitizen's color parameters
     * by a given amound.
     * @param {object} args - the block arguments.
     *  @property {ColorParam} COLOR_PARAM - the name of the selected color parameter.
     *  @property {number} VALUE - the amount to change the selected parameter by.
     * @param {object} util - utility object provided by the runtime.
     */
    changeSmartcitizenColorParamBy (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        this._setOrChangeColorParam(args.COLOR_PARAM, Cast.toNumber(args.VALUE), SmartcitizenState, true);
    }

    /**
     * The "set Smartcitizen {ColorParam} to {number}" block sets one of the Smartcitizen's color parameters
     * to a given amound.
     * @param {object} args - the block arguments.
     *  @property {ColorParam} COLOR_PARAM - the name of the selected color parameter.
     *  @property {number} VALUE - the amount to set the selected parameter to.
     * @param {object} util - utility object provided by the runtime.
     */
    setSmartcitizenColorParamTo (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        this._setOrChangeColorParam(args.COLOR_PARAM, Cast.toNumber(args.VALUE), SmartcitizenState, false);
    }


    /**
     * The Smartcitizen "Get Smartcitizen Data by KIT {number}" block changes the Smartcitizen size by the given amount.
     * @param {object} args - the block arguments.
     *  @property {number} SIZE - the amount of desired size change.
     * @param {object} util - utility object provided by the runtime.
     */
    getSmartcitizenKitData (args, util) {

      const http = new XMLHttpRequest();
      switch(args.ID){
        case "4267":http.open("GET", "https://api.smartcitizen.me/v0/devices/4267/readings?sensor_id=29&rollup=24h&from=2018-08-16%20"+args.HOUR+":00:00&to=2018-08-17%2000:00:00",false);
                  break;
        case "4357":http.open("GET", "https://api.smartcitizen.me/v0/devices/4357/readings?sensor_id=23&rollup=24h&from=2018-08-16%20"+args.HOUR+":00:00&to=2018-08-17%2000:00:00",false);
                  break;
      }
      //http.open("GET", "https://api.smartcitizen.me/v0/devices/4267/readings?sensor_id=29&rollup=24h&from=2018-08-16%20"+args.HOUR+":00:00&to=2018-08-17%2000:00:00",false);
      //Turo Peira http.open("GET", "https://api.smartcitizen.me/v0/devices/4357/readings?sensor_id=23&rollup=24h&from=2018-08-10%2002:00:00&to=2018-08-11%2002:00:00",false);
      http.send();
      //http.onload = () => var obj;
      var obj = JSON.parse(http.responseText);
      var noiseLevel = parseInt(obj.readings[0][1]);

      //alert(noiseLevel);

        const SmartcitizenAttributes = this._getSmartcitizenState(util.target).SmartcitizenAttributes;
        return noiseLevel;
        //return http.responseText;
        //SmartcitizenAttributes.diameter = this._clampSmartcitizenSize(SmartcitizenAttributes.diameter + Cast.toNumber(args.SIZE));
      //alert("Kit ID:"+args.ID+"  Day:"+args.DAY+ " Hour:"+args.HOUR+ " Variable:"+args.VARIABLE);

    }


    /** END DAYS PARAMS ** /

    /**
     * The Smartcitizen "change Smartcitizen size by {number}" block changes the Smartcitizen size by the given amount.
     * @param {object} args - the block arguments.
     *  @property {number} SIZE - the amount of desired size change.
     * @param {object} util - utility object provided by the runtime.
     */
    changeSmartcitizenIDBy (args, util) {
        const SmartcitizenAttributes = this._getSmartcitizenState(util.target).SmartcitizenAttributes;
        SmartcitizenAttributes.diameter = this._clampSmartcitizenSize(SmartcitizenAttributes.diameter + Cast.toNumber(args.SIZE));
    }

    /**
     * The Smartcitizen "set Smartcitizen size to {number}" block sets the Smartcitizen size to the given amount.
     * @param {object} args - the block arguments.
     *  @property {number} SIZE - the amount of desired size change.
     * @param {object} util - utility object provided by the runtime.
     */
    setSmartcitizenSizeTo (args, util) {
        const SmartcitizenAttributes = this._getSmartcitizenState(util.target).SmartcitizenAttributes;
        SmartcitizenAttributes.diameter = this._clampSmartcitizenSize(Cast.toNumber(args.SIZE));
    }

    /* LEGACY OPCODES */
    /**
     * Scratch 2 "hue" param is equivelant to twice the new "color" param.
     * @param {object} args - the block arguments.
     *  @property {number} HUE - the amount to set the hue to.
     * @param {object} util - utility object provided by the runtime.
     */
    setSmartcitizenHueToNumber (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        const hueValue = Cast.toNumber(args.HUE);
        const colorValue = hueValue / 2;
        this._setOrChangeColorParam(ColorParam.COLOR, colorValue, SmartcitizenState, false);

        this._legacyUpdateSmartcitizenColor(SmartcitizenState);
    }

    /**
     * Scratch 2 "hue" param is equivelant to twice the new "color" param.
     * @param {object} args - the block arguments.
     *  @property {number} HUE - the amount of desired hue change.
     * @param {object} util - utility object provided by the runtime.
     */
    changeSmartcitizenHueBy (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        const hueChange = Cast.toNumber(args.HUE);
        const colorChange = hueChange / 2;
        this._setOrChangeColorParam(ColorParam.COLOR, colorChange, SmartcitizenState, true);

        this._legacyUpdateSmartcitizenColor(SmartcitizenState);
    }

    /**
     * Use legacy "set shade" code to calculate RGB value for shade,
     * then convert back to HSV and store those components.
     * It is important to also track the given shade in SmartcitizenState._shade
     * because it cannot be accurately backed out of the new HSV later.
     * @param {object} args - the block arguments.
     *  @property {number} SHADE - the amount to set the shade to.
     * @param {object} util - utility object provided by the runtime.
     */
    setSmartcitizenShadeToNumber (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        let newShade = Cast.toNumber(args.SHADE);

        // Wrap clamp the new shade value the way scratch 2 did.
        newShade = newShade % 200;
        if (newShade < 0) newShade += 200;

        // And store the shade that was used to compute this new color for later use.
        SmartcitizenState._shade = newShade;

        this._legacyUpdateSmartcitizenColor(SmartcitizenState);
    }

    /**
     * Because "shade" cannot be backed out of hsv consistently, use the previously
     * stored SmartcitizenState._shade to make the shade change.
     * @param {object} args - the block arguments.
     *  @property {number} SHADE - the amount of desired shade change.
     * @param {object} util - utility object provided by the runtime.
     */
    changeSmartcitizenShadeBy (args, util) {
        const SmartcitizenState = this._getSmartcitizenState(util.target);
        const shadeChange = Cast.toNumber(args.SHADE);
        this.setSmartcitizenShadeToNumber({SHADE: SmartcitizenState._shade + shadeChange}, util);
    }

    /**
     * Update the Smartcitizen state's color from its hue & shade values, Scratch 2.0 style.
     * @param {object} SmartcitizenState - update the HSV & RGB values in this Smartcitizen state from its hue & shade values.
     * @private
     */
    _legacyUpdateSmartcitizenColor (SmartcitizenState) {
        // Create the new color in RGB using the scratch 2 "shade" model
        let rgb = Color.hsvToRgb({h: SmartcitizenState.color * 360 / 100, s: 1, v: 1});
        const shade = (SmartcitizenState._shade > 100) ? 200 - SmartcitizenState._shade : SmartcitizenState._shade;
        if (shade < 50) {
            rgb = Color.mixRgb(Color.RGB_BLACK, rgb, (10 + shade) / 60);
        } else {
            rgb = Color.mixRgb(rgb, Color.RGB_WHITE, (shade - 50) / 60);
        }

        // Update the Smartcitizen state according to new color
        const hsv = Color.rgbToHsv(rgb);
        SmartcitizenState.color = 100 * hsv.h / 360;
        SmartcitizenState.saturation = 100 * hsv.s;
        SmartcitizenState.brightness = 100 * hsv.v;

        this._updateSmartcitizenColor(SmartcitizenState);
    }
}

module.exports = Scratch3SmartcitizenBlocks;
